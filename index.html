<?php
// ==============================
// 險ｭ螳�
// ==============================
$proxy_script = 'test.php';
$timeout = 8;

// ==============================
// URL 縺ｮ蜿門ｾ�
// ==============================
$target_url = $_GET['url'] ?? '';

if (!$target_url) {
?>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>蠢懃畑逧�焚蟄ｦ</title>
<style>
    body {
        background: #111;
        color: #eee;
        font-family: Arial, sans-serif;
        text-align: center;
        padding-top: 80px;
    }
    h1 {
        font-size: 32px;
        margin-bottom: 20px;
        color: #fff;
        letter-spacing: 2px;
    }
    .box {
        background: #1c1c1c;
        display: inline-block;
        padding: 25px 40px;
        border-radius: 6px;
        border: 1px solid #333;
        text-align: left;
    }
    input[type="text"] {
        width: 380px;
        padding: 10px;
        border: none;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 15px;
    }
    button {
        padding: 10px 25px;
        background: #444;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 15px;
    }
    button:hover {
        background: #666;
    }
    .opts {
        margin-top: 15px;
        font-size: 14px;
        line-height: 1.8;
    }
    .footer {
        margin-top: 40px;
        font-size: 12px;
        color: #777;
    }
</style>
</head>
<body>

<h1>蠢懃畑逧�焚蟄ｦ Proxy</h1>

<div class="box">
    <form method="get" action="test.php">
        <input type="text" name="url" placeholder="https://example.com"><br>

        <div class="opts">
            <label><input type="checkbox" name="noscript"> Remove Scripts</label><br>
            <label><input type="checkbox" name="noimg"> Remove Images</label><br>
            <label><input type="checkbox" name="nocss"> Remove CSS</label><br>
            <label><input type="checkbox" name="showurl"> Show URL</label><br>

            <label>User-Agent:
                <select name="ua">
                    <option value="">Default</option>
                    <option value="Mozilla/5.0 (Windows NT 10.0)">Windows 10</option>
                    <option value="Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)">iPhone</option>
                    <option value="Mozilla/5.0 (Linux; Android 10)">Android</option>
                </select>
            </label>
        </div>

        <br>
        <button type="submit">Go</button>
    </form>
</div>

<div class="footer">
    updated窶叢hproxy style / lightweight modern PHP proxy
</div>

</body>
</html>
<?php
exit;
}

// ==============================
// URL 繝舌Μ繝��繧ｷ繝ｧ繝ｳ
// ==============================
if (!preg_match('!^https?://!i', $target_url)) {
    exit("http/https 縺ｮ縺ｿ蟇ｾ蠢�");
}

// ==============================
// Options
// ==============================
$noscript = isset($_GET['noscript']);
$noimg    = isset($_GET['noimg']);
$nocss    = isset($_GET['nocss']);
$showurl  = isset($_GET['showurl']);
$ua       = $_GET['ua'] ?? ($_SERVER['HTTP_USER_AGENT'] ?? 'Mozilla/5.0');

// ==============================
// 螟夜Κ繧ｵ繧､繝亥叙蠕暦ｼ�cURL��
// ==============================
$ch = curl_init($target_url);
curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_USERAGENT      => $ua,
    CURLOPT_ENCODING       => '',
    CURLOPT_TIMEOUT        => $timeout,
    CURLOPT_CONNECTTIMEOUT => $timeout,
    CURLOPT_HEADER         => false,
]);

$body = curl_exec($ch);
$content_type = curl_getinfo($ch, CURLINFO_CONTENT_TYPE) ?: '';
curl_close($ch);

// ==============================
// HTML 莉･螟悶�縺昴�縺ｾ縺ｾ霑斐☆�育判蜒上�CSS繝ｻJS��
// ==============================
if (stripos($content_type, 'text/html') === false) {

    // Remove Images
    if ($noimg && preg_match('!image/!i', $content_type)) {
        exit;
    }

    header("Content-Type: $content_type");
    echo $body;
    exit;
}

// ==============================
// 譁�ｭ励さ繝ｼ繝峨ｒ UTF-8 縺ｫ邨ｱ荳
// ==============================
$charset = null;

if (preg_match('/charset=([\w\-]+)/i', $content_type, $m)) {
    $charset = $m[1];
} elseif (preg_match('/<meta[^>]+charset=["\']?([\w\-]+)["\']?/i', $body, $m)) {
    $charset = $m[1];
}

if (!$charset) $charset = 'UTF-8';

if (strtoupper($charset) !== 'UTF-8') {
    $body = @mb_convert_encoding($body, 'UTF-8', $charset);
}

// ==============================
// 繝吶�繧ｹURL
// ==============================
$parsed = parse_url($target_url);
$scheme = $parsed['scheme'];
$host   = $parsed['host'];
$port   = isset($parsed['port']) ? ':' . $parsed['port'] : '';
$path   = $parsed['path'] ?? '/';

$base_url = $scheme . '://' . $host . $port;
$base_dir = rtrim(
    $base_url . (substr($path, -1) === '/' ? $path : dirname($path) . '/'),
    '/'
);

// ==============================
// 逶ｸ蟇ｾURL 竊� 邨ｶ蟇ｾURL
// ==============================
function abs_url($url, $base_url, $base_dir) {
    if (preg_match('!^https?://!i', $url)) return $url;
    if (strpos($url, '//') === 0)        return 'http:' . $url;
    if (strpos($url, '/') === 0)         return $base_url . $url;
    return $base_dir . '/' . $url;
}

// ==============================
// Remove Scripts / Images / CSS
// ==============================
if ($noscript) {
    $body = preg_replace('/<script\b[^>]*>.*?<\/script>/is', '', $body);
}
if ($noimg) {
    $body = preg_replace('/<img\b[^>]*>/i', '', $body);
}
if ($nocss) {
    $body = preg_replace('/<link[^>]+stylesheet[^>]*>/i', '', $body);
    $body = preg_replace('/<style\b[^>]*>.*?<\/style>/is', '', $body);
}

// ==============================
// favicon 繧貞ｼｷ蛻ｶ逧�↓ favicon.ico 縺ｫ蝗ｺ螳�
// ==============================
$body = preg_replace('/<link[^>]+rel=["\']icon["\'][^>]*>/i', '', $body);
$body = preg_replace(
    '/<head[^>]*>/i',
    '$0<link rel="icon" href="favicon.ico" type="image/x-icon">',
    $body,
    1
);

// ==============================
// href / src 譖ｸ縺肴鋤縺�
// ==============================
$body = preg_replace_callback(
    '/\b(href|src)\s*=\s*["\']([^"\']+)["\']/i',
    function ($m) use ($base_url, $base_dir, $proxy_script, $noscript, $noimg, $nocss, $showurl, $ua) {

        $attr = $m[1];
        $url  = $m[2];

        if (preg_match('!^(javascript:|data:)!i', $url)) {
            return $m[0];
        }

        $abs = abs_url($url, $base_url, $base_dir);

        $params = [
            'url' => $abs
        ];
        if ($noscript) $params['noscript'] = 1;
        if ($noimg)    $params['noimg']    = 1;
        if ($nocss)    $params['nocss']    = 1;
        if ($showurl)  $params['showurl']  = 1;
        if ($ua)       $params['ua']       = $ua;

        $prox = $proxy_script . '?' . http_build_query($params);

        return $attr . '="' . htmlspecialchars($prox, ENT_QUOTES, 'UTF-8') . '"';
    },
    $body
);

// ==============================
// Show URL�医�繝ｼ繧ｸ荳企Κ縺ｫ蜈ザRL繧定｡ｨ遉ｺ��
// ==============================
if ($showurl) {
    $show = '<div style="background:#222;color:#eee;padding:8px;font-size:13px;">'
          . 'URL: ' . htmlspecialchars($target_url, ENT_QUOTES, 'UTF-8')
          . '</div>';
    $body = preg_replace('/<body[^>]*>/i', '$0' . $show, $body, 1);
}

// ==============================
// 繧ｿ繧､繝医Ν繧偵悟ｿ懃畑逧�焚蟄ｦ縲阪↓蠑ｷ蛻ｶ
// ==============================
$body = preg_replace(
    '/<title[^>]*>.*?<\/title>/is',
    '<title>蠢懃畑逧�焚蟄ｦ</title>',
    $body,
    1
);

// ==============================
// 蜃ｺ蜉幢ｼ医く繝｣繝�す繝･螳悟�縺ｪ縺暦ｼ�
// ==============================
header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');
header('Pragma: no-cache');
header('Expires: 0');

      header ( 'Content-Type: text/html; charset=UTF-8' ) ; 
      echo $body;
